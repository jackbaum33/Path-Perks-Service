<!-- Upsell + Stripe Checkout Integration -->
<!-- Bundle All Checkbox -->
<div style="margin-bottom: 1em;">
  <input type="checkbox" id="bundle-all" />
  <label for="bundle-all"><strong>Bundle all</strong></label>
</div>

<!-- Product List -->
<div id="upsell-products"></div>

<!-- Checkout Button -->
<button id="checkout-button" style="margin-top: 1em; padding: 10px 20px;">Continue to Checkout</button>

<script>
const API_URL = "https://revshot-service.onrender.com";
let selectedItems = [];

// âœ… Get cart total from URL
const urlParams = new URLSearchParams(window.location.search);
const originalTotal = parseInt(urlParams.get('amount')) || 0;

// Load enhancements
window.addEventListener('DOMContentLoaded', () => {
  loadEnhancements();
});

async function loadEnhancements() {
  try {
    const res = await fetch(`${API_URL}/api/enhancements`);
    const enhancements = await res.json();
    const container = document.getElementById("upsell-products");

    enhancements.forEach((item, index) => {
      const wrapper = document.createElement("div");
      wrapper.style.margin = "20px 0";
      wrapper.style.display = "flex";
      wrapper.style.alignItems = "center";
      wrapper.style.gap = "1em";

      const img = document.createElement("img");
      img.src = `${API_URL}/images/${index + 1}.png`;
      img.alt = item.name;
      img.style.width = "100px";
      img.style.height = "auto";
      img.style.borderRadius = "8px";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.classList.add("enhancement-checkbox");
      checkbox.id = `enhancement-${index}`;
      checkbox.dataset.name = item.name;
      checkbox.dataset.price = item.price;
      checkbox.onchange = handleSelection;

      const label = document.createElement("label");
      label.htmlFor = checkbox.id;
      label.innerHTML = `<strong>${item.name}</strong><br><small>${item.description}</small><br><span>$${(item.price / 100).toFixed(2)}</span>`;

      wrapper.appendChild(img);
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      container.appendChild(wrapper);
    });

    // Bundle all logic
    const bundleAllCheckbox = document.getElementById("bundle-all");
    bundleAllCheckbox.addEventListener("change", () => {
      const checkboxes = container.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach((box) => {
        box.checked = bundleAllCheckbox.checked;
        box.dispatchEvent(new Event("change")); // trigger selection logic
      });
    });

  } catch (e) {
    console.error("Error loading enhancements", e);
    document.getElementById("upsell-products").innerText = "Error loading enhancements";
  }
}

function handleSelection(e) {
  const checkbox = e.target;
  const name = checkbox.dataset.name;
  const price = parseInt(checkbox.dataset.price);

  // Always remove item first (whether checked or unchecked)
  selectedItems = selectedItems.filter(i => i.name !== name);

  // Re-add only if checkbox is checked
  if (checkbox.checked) {
    selectedItems.push({ name, price });
  }
}


document.getElementById("checkout-button").addEventListener("click", async () => {
  try {
    const siteName = window.location.hostname;
    const response = await fetch(`${API_URL}/api/create-checkout-session`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        items: selectedItems,
        originalTotal: originalTotal,
        siteName: siteName
      })
    });

    const data = await response.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("Checkout failed. Please try again.");
    }
  } catch (err) {
    console.error("Checkout error:", err);
    alert("An error occurred during checkout.");
  }
});
</script>
